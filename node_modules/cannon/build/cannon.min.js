(function(){var t=t||{};this.Int32Array||(this.Int32Array=Array,this.Float32Array=Array),t.Mat3=function(t){this.elements=t?t:[0,0,0,0,0,0,0,0,0]},t.Mat3.prototype.identity=function(){this.elements[0]=1,this.elements[1]=0,this.elements[2]=0,this.elements[3]=0,this.elements[4]=1,this.elements[5]=0,this.elements[6]=0,this.elements[7]=0,this.elements[8]=1},t.Mat3.prototype.setZero=function(){var t=this.elements;t[0]=0,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t[8]=0},t.Mat3.prototype.setTrace=function(t){var e=this.elements;e[0]=t.x,e[4]=t.y,e[8]=t.z},t.Mat3.prototype.vmult=function(e,i){i=i||new t.Vec3;var n=this.elements,o=e.x,a=e.y,r=e.z;return i.x=n[0]*o+n[1]*a+n[2]*r,i.y=n[3]*o+n[4]*a+n[5]*r,i.z=n[6]*o+n[7]*a+n[8]*r,i},t.Mat3.prototype.smult=function(t){for(var e=0;this.elements.length>e;e++)this.elements[e]*=t},t.Mat3.prototype.mmult=function(e){for(var i=new t.Mat3,n=0;3>n;n++)for(var o=0;3>o;o++){for(var a=0,r=0;3>r;r++)a+=e.elements[n+3*r]*this.elements[r+3*o];i.elements[n+3*o]=a}return i},t.Mat3.prototype.solve=function(e,i){i=i||new t.Vec3;for(var n=3,o=4,a=[],r=0;n*o>r;r++)a.push(0);var r,s;for(r=0;3>r;r++)for(s=0;3>s;s++)a[r+o*s]=this.elements[r+3*s];a[3]=e.x,a[7]=e.y,a[11]=e.z;var h,c,l=3,u=l,p=4;do{if(r=u-l,0===a[r+o*r])for(s=r+1;u>s;s++)if(0!==a[r+o*s]){h=p;do c=p-h,a[c+o*r]+=a[c+o*s];while(--h);break}if(0!==a[r+o*r])for(s=r+1;u>s;s++){var v=a[r+o*s]/a[r+o*r];h=p;do c=p-h,a[c+o*s]=r>=c?0:a[c+o*s]-a[c+o*r]*v;while(--h)}}while(--l);if(i.z=a[2*o+3]/a[2*o+2],i.y=(a[1*o+3]-a[1*o+2]*i.z)/a[1*o+1],i.x=(a[0*o+3]-a[0*o+2]*i.z-a[0*o+1]*i.y)/a[0*o+0],isNaN(i.x)||isNaN(i.y)||isNaN(i.z)||1/0===i.x||1/0===i.y||1/0===i.z)throw"Could not solve equation! Got x=["+(""+i)+"], b=["+(""+e)+"], A=["+(""+this)+"]";return i},t.Mat3.prototype.e=function(t,e,i){return void 0===i?this.elements[e+3*t]:(this.elements[e+3*t]=i,void 0)},t.Mat3.prototype.copy=function(e){e=e||new t.Mat3;for(var i=0;this.elements.length>i;i++)e.elements[i]=this.elements[i];return e},t.Mat3.prototype.toString=function(){for(var t="",e=",",i=0;9>i;i++)t+=this.elements[i]+e;return t},t.Mat3.prototype.reverse=function(e){e=e||new t.Mat3;for(var i=3,n=6,o=[],a=0;i*n>a;a++)o.push(0);var a,r;for(a=0;3>a;a++)for(r=0;3>r;r++)o[a+n*r]=this.elements[a+3*r];o[3]=1,o[9]=0,o[15]=0,o[4]=0,o[10]=1,o[16]=0,o[5]=0,o[11]=0,o[17]=1;var s,h,c=3,l=c,u=n;do{if(a=l-c,0===o[a+n*a])for(r=a+1;l>r;r++)if(0!==o[a+n*r]){s=u;do h=u-s,o[h+n*a]+=o[h+n*r];while(--s);break}if(0!==o[a+n*a])for(r=a+1;l>r;r++){var p=o[a+n*r]/o[a+n*a];s=u;do h=u-s,o[h+n*r]=a>=h?0:o[h+n*r]-o[h+n*a]*p;while(--s)}}while(--c);a=2;do{r=a-1;do{var p=o[a+n*r]/o[a+n*a];s=n;do h=n-s,o[h+n*r]=o[h+n*r]-o[h+n*a]*p;while(--s)}while(r--)}while(--a);a=2;do{var p=1/o[a+n*a];s=n;do h=n-s,o[h+n*a]=o[h+n*a]*p;while(--s)}while(a--);a=2;do{r=2;do{if(h=o[i+r+n*a],isNaN(h)||1/0===h)throw"Could not reverse! A=["+(""+this)+"]";e.e(a,r,h)}while(r--)}while(a--);return e},t.Vec3=function(t,e,i){this.x=t||0,this.y=e||0,this.z=i||0},t.Vec3.prototype.cross=function(e,i){var n=e.x,o=e.y,a=e.z,r=this.x,s=this.y,h=this.z;return i=i||new t.Vec3,i.x=s*a-h*o,i.y=h*n-r*a,i.z=r*o-s*n,i},t.Vec3.prototype.set=function(t,e,i){return this.x=t,this.y=e,this.z=i,this},t.Vec3.prototype.vadd=function(e,i){return i?(i.x=e.x+this.x,i.y=e.y+this.y,i.z=e.z+this.z,void 0):new t.Vec3(this.x+e.x,this.y+e.y,this.z+e.z)},t.Vec3.prototype.vsub=function(e,i){return i?(i.x=this.x-e.x,i.y=this.y-e.y,i.z=this.z-e.z,void 0):new t.Vec3(this.x-e.x,this.y-e.y,this.z-e.z)},t.Vec3.prototype.crossmat=function(){return new t.Mat3([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},t.Vec3.prototype.normalize=function(){var t=this.x,e=this.y,i=this.z,n=Math.sqrt(t*t+e*e+i*i);if(n>0){var o=1/n;this.x*=o,this.y*=o,this.z*=o}else this.x=0,this.y=0,this.z=0;return n},t.Vec3.prototype.unit=function(e){e=e||new t.Vec3;var i=this.x,n=this.y,o=this.z,a=Math.sqrt(i*i+n*n+o*o);return a>0?(a=1/a,e.x=i*a,e.y=n*a,e.z=o*a):(e.x=1,e.y=0,e.z=0),e},t.Vec3.prototype.norm=function(){var t=this.x,e=this.y,i=this.z;return Math.sqrt(t*t+e*e+i*i)},t.Vec3.prototype.norm2=function(){return this.dot(this)},t.Vec3.prototype.distanceTo=function(t){var e=this.x,i=this.y,n=this.z,o=t.x,a=t.y,r=t.z;return Math.sqrt((o-e)*(o-e)+(a-i)*(a-i)+(r-n)*(r-n))},t.Vec3.prototype.mult=function(e,i){i=i||new t.Vec3;var n=this.x,o=this.y,a=this.z;return i.x=e*n,i.y=e*o,i.z=e*a,i},t.Vec3.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},t.Vec3.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},t.Vec3.prototype.negate=function(e){return e=e||new t.Vec3,e.x=-this.x,e.y=-this.y,e.z=-this.z,e};var e=new t.Vec3,i=new t.Vec3;t.Vec3.prototype.tangents=function(t,n){var o=this.norm();if(o>0){var a=e,r=1/o;a.set(this.x*r,this.y*r,this.z*r);var s=i;.9>Math.abs(a.x)?(s.set(1,0,0),a.cross(s,t)):(s.set(0,1,0),a.cross(s,t)),a.cross(t,n)}else t.set(1,0,0).normalize(),n.set(0,1,0).normalize()},t.Vec3.prototype.toString=function(){return this.x+","+this.y+","+this.z},t.Vec3.prototype.copy=function(e){return e=e||new t.Vec3,e.x=this.x,e.y=this.y,e.z=this.z,e},t.Vec3.prototype.lerp=function(t,e,i){var n=this.x,o=this.y,a=this.z;i.x=n+(t.x-n)*e,i.y=o+(t.y-o)*e,i.z=a+(t.z-a)*e},t.Vec3.prototype.almostEquals=function(t,e){return void 0===e&&(e=1e-6),Math.abs(this.x-t.x)>e||Math.abs(this.y-t.y)>e||Math.abs(this.z-t.z)>e?!1:!0},t.Vec3.prototype.almostZero=function(t){return void 0===t&&(t=1e-6),Math.abs(this.x)>t||Math.abs(this.y)>t||Math.abs(this.z)>t?!1:!0},t.Quaternion=function(t,e,i,n){this.x=void 0!==t?t:0,this.y=void 0!==e?e:0,this.z=void 0!==i?i:0,this.w=void 0!==n?n:1},t.Quaternion.prototype.set=function(t,e,i,n){this.x=t,this.y=e,this.z=i,this.w=n},t.Quaternion.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},t.Quaternion.prototype.setFromAxisAngle=function(t,e){var i=Math.sin(.5*e);this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this.w=Math.cos(.5*e)},t.Quaternion.prototype.toAxisAngle=function(e){e=e||new t.Vec3,this.normalize();var i=2*Math.acos(this.w),n=Math.sqrt(1-this.w*this.w);return.001>n?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/n,e.y=this.y/n,e.z=this.z/n),[e,i]},t.Quaternion.prototype.setFromVectors=function(t,e){var i=t.cross(e);this.x=i.x,this.y=i.y,this.z=i.z,this.w=Math.sqrt(Math.pow(t.norm(),2)*Math.pow(e.norm(),2))+t.dot(e),this.normalize()};var n=new t.Vec3,o=new t.Vec3,a=new t.Vec3;t.Quaternion.prototype.mult=function(e,i){i=i||new t.Quaternion;var r=this.w,s=n,h=o,c=a;return s.set(this.x,this.y,this.z),h.set(e.x,e.y,e.z),i.w=r*e.w-s.dot(h),s.cross(h,c),i.x=r*h.x+e.w*s.x+c.x,i.y=r*h.y+e.w*s.y+c.y,i.z=r*h.z+e.w*s.z+c.z,i},t.Quaternion.prototype.inverse=function(e){var i=this.x,n=this.y,o=this.z,a=this.w;e=e||new t.Quaternion,this.conjugate(e);var r=1/(i*i+n*n+o*o+a*a);return e.x*=r,e.y*=r,e.z*=r,e.w*=r,e},t.Quaternion.prototype.conjugate=function(e){return e=e||new t.Quaternion,e.x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e},t.Quaternion.prototype.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t)},t.Quaternion.prototype.normalizeFast=function(){var t=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=t,this.y*=t,this.z*=t,this.w*=t)},t.Quaternion.prototype.vmult=function(e,i){if(i=i||new t.Vec3,0===this.w)i.x=e.x,i.y=e.y,i.z=e.z;else{var n=e.x,o=e.y,a=e.z,r=this.x,s=this.y,h=this.z,c=this.w,l=c*n+s*a-h*o,u=c*o+h*n-r*a,p=c*a+r*o-s*n,v=-r*n-s*o-h*a;i.x=l*c+v*-r+u*-h-p*-s,i.y=u*c+v*-s+p*-r-l*-h,i.z=p*c+v*-h+l*-s-u*-r}return i},t.Quaternion.prototype.copy=function(t){t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w},t.Quaternion.prototype.toEuler=function(t,e){e=e||"YZX";var i,n,o,a=this.x,r=this.y,s=this.z,h=this.w;switch(e){case"YZX":var c=a*r+s*h;if(c>.499&&(i=2*Math.atan2(a,h),n=Math.PI/2,o=0),-.499>c&&(i=-2*Math.atan2(a,h),n=-Math.PI/2,o=0),isNaN(i)){var l=a*a,u=r*r,p=s*s;i=Math.atan2(2*r*h-2*a*s,1-2*u-2*p),n=Math.asin(2*c),o=Math.atan2(2*a*h-2*r*s,1-2*l-2*p)}break;default:throw Error("Euler order "+e+" not supported yet.")}t.y=i,t.z=n,t.x=o},t.EventTarget=function(){var t={};this.addEventListener=function(e,i){void 0===t[e]&&(t[e]=[]),-1===t[e].indexOf(i)&&t[e].push(i)},this.dispatchEvent=function(e){for(var i in t[e.type])t[e.type][i](e)},this.removeEventListener=function(e,i){var n=t[e].indexOf(i);-1!==n&&t[e].splice(n,1)}},t.ObjectPool=function(){this.objects=[],this.type=Object},t.ObjectPool.prototype.release=function(){for(var t=arguments.length,e=0;e!==t;e++)this.objects.push(arguments[e])},t.ObjectPool.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},t.ObjectPool.prototype.constructObject=function(){throw Error("constructObject() not implemented in this ObjectPool subclass yet!")},t.Vec3Pool=function(){t.ObjectPool.call(this),this.type=t.Vec3},t.Vec3Pool.prototype=new t.ObjectPool,t.Vec3Pool.prototype.constructObject=function(){return new t.Vec3},t.Shape=function(){this.type=0,this.aabbmin=new t.Vec3,this.aabbmax=new t.Vec3,this.boundingSphereRadius=0,this.boundingSphereRadiusNeedsUpdate=!0},t.Shape.prototype.constructor=t.Shape,t.Shape.prototype.computeBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},t.Shape.prototype.getBoundingSphereRadius=function(){return this.boundingSphereRadiusNeedsUpdate&&this.computeBoundingSphereRadius(),this.boundingSphereRadius},t.Shape.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},t.Shape.prototype.calculateLocalInertia=function(){throw"calculateLocalInertia() not implemented for shape type "+this.type};var r=new t.Vec3,s=new t.Vec3;t.Shape.prototype.calculateTransformedInertia=function(e,i,n){n=n||new t.Vec3;var o=r,a=s;return this.calculateLocalInertia(e,o),i.vmult(o,a),n.x=Math.abs(a.x),n.y=Math.abs(a.y),n.z=Math.abs(a.z),n},t.Shape.calculateLocalAABB=function(){throw Error(".calculateLocalAABB is not implemented for this Shape yet!")},t.Shape.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16},t.Body=function(e){t.EventTarget.apply(this),this.type=e,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new t.Vec3,this.collisionFilterGroup=1,this.collisionFilterMask=1},t.Body.DYNAMIC=1,t.Body.STATIC=2,t.Body.KINEMATIC=4,t.Particle=function(e,i){if("number"!=typeof e)throw Error("Argument 1 (mass) must be a number.");if(i!==void 0&&!(i instanceof t.Material))throw Error("Argument 3 (material) must be an instance of CANNON.Material.");t.Body.call(this,"particle"),this.position=new t.Vec3,this.initPosition=new t.Vec3,this.velocity=new t.Vec3,this.initVelocity=new t.Vec3,this.force=new t.Vec3,this.mass=e,this.invMass=e>0?1/e:0,this.material=i,this.linearDamping=.01,this.motionstate=0>=e?t.Body.STATIC:t.Body.DYNAMIC,this.allowSleep=!0,this.sleepState=0,this.sleepSpeedLimit=.1,this.sleepTimeLimit=1,this.timeLastSleepy=0},t.Particle.prototype=new t.Body,t.Particle.prototype.constructor=t.Particle,t.Particle.prototype.isAwake=function(){return 0===this.sleepState},t.Particle.prototype.isSleepy=function(){return 1===this.sleepState},t.Particle.prototype.isSleeping=function(){return 2===this.sleepState},t.Particle.prototype.wakeUp=function(){var t=this.sleepState;this.sleepState=0,2===t&&this.dispatchEvent({type:"wakeup"})},t.Particle.prototype.sleep=function(){this.sleepState=2},t.Particle.prototype.sleepTick=function(t){if(this.allowSleep){var e=this.sleepState,i=this.velocity.norm2(),n=Math.pow(this.sleepSpeedLimit,2);0===e&&n>i?(this.sleepState=1,this.timeLastSleepy=t,this.dispatchEvent({type:"sleepy"})):1===e&&i>n?this.wakeUp():1===e&&t-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleepState=2,this.dispatchEvent({type:"sleep"}))}},t.RigidBody=function(e,i,n){if("number"!=typeof e)throw Error("Argument 1 (mass) must be a number.");if(n!==void 0&&!(n instanceof t.Material))throw Error("Argument 3 (material) must be an instance of CANNON.Material.");t.Particle.call(this,e,n),this.tau=new t.Vec3,this.quaternion=new t.Quaternion,this.initQuaternion=new t.Quaternion,this.angularVelocity=new t.Vec3,this.initAngularVelocity=new t.Vec3,this.shape=i,this.inertia=new t.Vec3,i.calculateLocalInertia(e,this.inertia),this.inertiaWorld=new t.Vec3,this.inertia.copy(this.inertiaWorld),this.inertiaWorldAutoUpdate=!1,this.invInertia=new t.Vec3(this.inertia.x>0?1/this.inertia.x:0,this.inertia.y>0?1/this.inertia.y:0,this.inertia.z>0?1/this.inertia.z:0),this.invInertiaWorld=new t.Vec3,this.invInertia.copy(this.invInertiaWorld),this.invInertiaWorldAutoUpdate=!1,this.angularDamping=.01,this.aabbmin=new t.Vec3,this.aabbmax=new t.Vec3,this.aabbNeedsUpdate=!0,this.wlambda=new t.Vec3},t.RigidBody.prototype=new t.Particle(0),t.RigidBody.prototype.constructor=t.RigidBody,t.RigidBody.prototype.computeAABB=function(){this.shape.calculateWorldAABB(this.position,this.quaternion,this.aabbmin,this.aabbmax),this.aabbNeedsUpdate=!1},t.RigidBody.prototype.applyImpulse=function(e,i,n){n=n||1/60;var o=new t.Vec3,a=new t.Vec3;e.vsub(this.position,o),o.cross(i,a),this.velocity.vadd(i.mult(n),this.velocity),this.angularVelocity.vadd(a.mult(n),this.angularVelocity)},t.Sphere=function(e){t.Shape.call(this),this.radius=void 0!==e?Number(e):1,this.type=t.Shape.types.SPHERE},t.Sphere.prototype=new t.Shape,t.Sphere.prototype.constructor=t.Sphere,t.Sphere.prototype.calculateLocalInertia=function(e,i){i=i||new t.Vec3;var n=2*e*this.radius*this.radius/5;return i.x=n,i.y=n,i.z=n,i},t.Sphere.prototype.volume=function(){return 4*Math.PI*this.radius/3},t.Sphere.prototype.computeBoundingSphereRadius=function(){this.boundingSphereRadiusNeedsUpdate=!1,this.boundingSphereRadius=this.radius},t.Sphere.prototype.calculateWorldAABB=function(t,e,i,n){for(var o=this.radius,a=["x","y","z"],r=0;a.length>r;r++){var s=a[r];i[s]=t[s]-o,n[s]=t[s]+o}},t.Box=function(e){t.Shape.call(this),this.halfExtents=e,this.type=t.Shape.types.BOX,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation()},t.Box.prototype=new t.Shape,t.Box.prototype.constructor=t.Box,t.Box.prototype.updateConvexPolyhedronRepresentation=function(){var e=this.halfExtents.x,i=this.halfExtents.y,n=this.halfExtents.z,o=t.Vec3,a=new t.ConvexPolyhedron([new o(-e,-i,-n),new o(e,-i,-n),new o(e,i,-n),new o(-e,i,-n),new o(-e,-i,n),new o(e,-i,n),new o(e,i,n),new o(-e,i,n)],[[3,2,1,0],[4,5,6,7],[5,4,1,0],[2,3,6,7],[0,4,7,3],[1,2,5,6]],[new o(0,0,-1),new o(0,0,1),new o(0,-1,0),new o(0,1,0),new o(-1,0,0),new o(1,0,0)]);this.convexPolyhedronRepresentation=a},t.Box.prototype.calculateLocalInertia=function(e,i){i=i||new t.Vec3;var n=this.halfExtents;return i.x=1/12*e*(2*2*n.y*n.y+2*2*n.z*n.z),i.y=1/12*e*(2*2*n.x*n.x+2*2*n.z*n.z),i.z=1/12*e*(2*2*n.y*n.y+2*2*n.x*n.x),i},t.Box.prototype.getSideNormals=function(t,e){var i=t,n=this.halfExtents;if(i[0].set(n.x,0,0),i[1].set(0,n.y,0),i[2].set(0,0,n.z),i[3].set(-n.x,0,0),i[4].set(0,-n.y,0),i[5].set(0,0,-n.z),void 0!==e)for(var o=0;o!==i.length;o++)e.vmult(i[o],i[o]);return i},t.Box.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},t.Box.prototype.computeBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm(),this.boundingSphereRadiusNeedsUpdate=!1};var h=new t.Vec3;new t.Vec3,t.Box.prototype.forEachWorldCorner=function(t,e,i){for(var n=this.halfExtents,o=[[n.x,n.y,n.z],[-n.x,n.y,n.z],[-n.x,-n.y,n.z],[-n.x,-n.y,-n.z],[n.x,-n.y,-n.z],[n.x,n.y,-n.z],[-n.x,n.y,-n.z],[n.x,-n.y,n.z]],a=0;o.length>a;a++)h.set(o[a][0],o[a][1],o[a][2]),e.vmult(h,h),t.vadd(h,h),i(h.x,h.y,h.z)},t.Box.prototype.calculateWorldAABB=function(t,e,i,n){i.set(1/0,1/0,1/0),n.set(-1/0,-1/0,-1/0),this.forEachWorldCorner(t,e,function(t,e,o){t>n.x&&(n.x=t),e>n.y&&(n.y=e),o>n.z&&(n.z=o),i.x>t&&(i.x=t),i.y>e&&(i.y=e),i.z>o&&(i.z=o)})},t.Plane=function(){t.Shape.call(this),this.type=t.Shape.types.PLANE,this.worldNormal=new t.Vec3,this.worldNormalNeedsUpdate=!0},t.Plane.prototype=new t.Shape,t.Plane.prototype.constructor=t.Plane,t.Plane.prototype.computeWorldNormal=function(t){var e=this.worldNormal;e.set(0,0,1),t.vmult(e,e),this.worldNormalNeedsUpdate=!1},t.Plane.prototype.calculateLocalInertia=function(e,i){return i=i||new t.Vec3},t.Plane.prototype.volume=function(){return 1/0};var c=new t.Vec3;t.Plane.prototype.calculateWorldAABB=function(t,e,i,n){c.set(0,0,1),e.vmult(c,c),i.set(-1/0,-1/0,-1/0),n.set(1/0,1/0,1/0),1===c.x&&(n.x=t.x),1===c.y&&(n.y=t.y),1===c.z&&(n.z=t.z),-1===c.x&&(i.x=t.x),-1===c.y&&(i.y=t.y),-1===c.z&&(i.z=t.z)},t.Compound=function(){t.Shape.call(this),this.type=t.Shape.types.COMPOUND,this.childShapes=[],this.childOffsets=[],this.childOrientations=[]},t.Compound.prototype=new t.Shape,t.Compound.prototype.constructor=t.Compound,t.Compound.prototype.addChild=function(e,i,n){i=i||new t.Vec3,n=n||new t.Quaternion,this.childShapes.push(e),this.childOffsets.push(i),this.childOrientations.push(n)},t.Compound.prototype.volume=function(){for(var t=0,e=this.childShapes.length,i=0;i!==e;i++)t+=this.childShapes[i].volume();return t};var l=new t.Vec3,u=new t.Vec3;t.Compound.prototype.calculateLocalInertia=function(e,i){i=i||new t.Vec3;for(var n=this.volume(),o=u,a=0,r=this.childShapes.length;a!==r;a++){var s=this.childShapes[a],h=this.childOffsets[a];this.childOrientations[a];var c=s.volume()/n*e;s.calculateLocalInertia(c,o),i.vadd(o,i);var p=l;p.set(c*h.x*h.x,c*h.y*h.y,c*h.z*h.z),i.vadd(p,i)}return i},t.Compound.prototype.computeBoundingSphereRadius=function(){for(var t=0,e=0;this.childShapes.length>e;e++){var i=this.childShapes[e];i.boundingSphereRadiusNeedsUpdate&&i.computeBoundingSphereRadius();var n=this.childOffsets[e].norm()+i.boundingSphereRadius;n>t&&(t=n)}this.boundingSphereRadius=t,this.boundingSphereRadiusNeedsUpdate=!1};var p=new t.Vec3,v=new t.Vec3,d=new t.Vec3,y=new t.Quaternion;t.Compound.prototype.calculateWorldAABB=function(t,e,i,n){var o=this.childShapes.length;i.set(1/0,1/0,1/0),n.set(-1/0,-1/0,-1/0);for(var a=0;a!==o;a++)this.childOffsets[a].copy(d),e.vmult(d,d),t.vadd(d,d),e.mult(this.childOrientations[a],y),this.childShapes[a].calculateWorldAABB(d,y,v,p),v.x<i.x&&(i.x=v.x),v.y<i.y&&(i.y=v.y),v.z<i.z&&(i.z=v.z),p.x>n.x&&(n.x=p.x),p.y>n.y&&(n.y=p.y),p.z>n.z&&(n.z=p.z)},t.ConvexPolyhedron=function(e,i){function n(t,e,i,n){e.vsub(t,c),i.vsub(e,h),h.cross(c,n),n.isZero()||n.normalize()}function o(t,e,i,n,o){for(var a=t.vertices.length,r=null,s=null,h=t.vertices,c=0;a>c;c++){h[c].copy(V),n.vmult(V,V),V.vadd(i,V);var l=V.dot(e);(null===r||l>r)&&(r=l),(null===s||s>l)&&(s=l)}if(s>r){var u=s;s=r,r=u}o[0]=r,o[1]=s}function a(t,e){var i=s.faces[t],o=s.vertices[i[0]],a=s.vertices[i[1]],r=s.vertices[i[2]];return n(o,a,r,e)}function r(t){var e=s.faces[t],i=s.faceNormals[t],n=s.vertices[e[0]],o=-i.dot(n);return o}var s=this;t.Shape.call(this),this.type=t.Shape.types.CONVEXPOLYHEDRON;var h=new t.Vec3,c=new t.Vec3;this.vertices=e||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=i||[],this.faceNormals=[];for(var l=0;this.faces.length>l;l++){for(var u=0;this.faces[l].length>u;u++)if(!this.vertices[this.faces[l][u]])throw Error("Vertex "+this.faces[l][u]+" not found!");var p=new t.Vec3;a(l,p),p.negate(p),this.faceNormals.push(p);var v=this.vertices[this.faces[l][0]];if(0>p.dot(v)){console.warn("Face normal "+l+" ("+(""+p)+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var u=0;this.faces[l].length>u;u++)console.warn("Vertex "+this.faces[l][u]+": ("+(""+this.vertices[i[l][u]])+")")}}this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[];for(var d=this.vertices.length,y=0;d>y;y++){var f=this.vertices[y];if(!(f instanceof t.Vec3))throw"Argument 1 must be instance of CANNON.Vec3";this.uniqueEdges.push(f)}for(var l=0;this.faces.length>l;l++)for(var m=this.faces[l].length,w=m,u=0;w>u;u++){var b=(u+1)%m,x=new t.Vec3;this.vertices[this.faces[l][u]].vsub(this.vertices[this.faces[l][b]],x),x.normalize();for(var g=!1,f=0;this.uniqueEdges.length>f;f++)if(this.uniqueEdges[f].almostEquals(x)||this.uniqueEdges[f].almostEquals(x)){g=!0;break}g||this.uniqueEdges.push(x),x&&(x.face1=l)}var V=new t.Vec3;this.testSepAxis=function(t,e,i,n,a,r){var s=[],h=[],c=this;o(c,t,i,n,s),o(e,t,a,r,h);var l=s[0],u=s[1],p=h[0],v=h[1];if(v>l||u>p)return!1;var d=l-v,y=p-u,f=y>d?d:y;return f};var z=new t.Vec3,E=new t.Vec3,N=new t.Vec3,S=new t.Vec3,M=new t.Vec3,j=new t.Vec3;this.findSeparatingAxis=function(t,e,i,n,o,a){for(var r=1/0,s=this,h=0,c=s.faces.length,l=0;c>l;l++){s.faceNormals[l].copy(z),i.vmult(z,z);var u=s.testSepAxis(z,t,e,i,n,o);if(u===!1)return!1;r>u&&(r=u,z.copy(a))}for(var p=t.faces.length,l=0;p>l;l++){t.faceNormals[l].copy(E),o.vmult(E,E),h++;var u=s.testSepAxis(E,t,e,i,n,o);if(u===!1)return!1;r>u&&(r=u,E.copy(a))}for(var v=0,d=0;s.uniqueEdges.length>d;d++){s.uniqueEdges[d].copy(S),i.vmult(S,S);for(var y=0;t.uniqueEdges.length>y;y++)if(t.uniqueEdges[y].copy(M),o.vmult(M,M),S.cross(M,j),v++,!j.almostZero()){j.normalize();var f=s.testSepAxis(j,t,e,i,n,o);if(f===!1)return!1;r>f&&(r=f,j.copy(a))}}return n.vsub(e,N),N.dot(a)>0&&a.negate(a),!0};var q=new t.Vec3;this.clipAgainstHull=function(e,i,n,o,a,r,s,h,c){if(!(e instanceof t.Vec3))throw Error("posA must be Vec3");if(!(i instanceof t.Quaternion))throw Error("quatA must be Quaternion");for(var l=-1,u=-1/0,p=0;n.faces.length>p;p++){n.faceNormals[p].copy(q),a.vmult(q,q);var v=q.dot(r);v>u&&(u=v,l=p)}for(var d=[],y=n.faces[l],f=y.length,m=0;f>m;m++){var w=n.vertices[y[m]],b=new t.Vec3;w.copy(b),a.vmult(b,b),o.vadd(b,b),d.push(b)}l>=0&&this.clipFaceAgainstHull(r,e,i,d,s,h,c)};var P=new t.Vec3,C=new t.Vec3,B=new t.Vec3,I=new t.Vec3,O=new t.Vec3,R=new t.Vec3,A=new t.Vec3,T=new t.Vec3;this.clipFaceAgainstHull=function(e,i,n,o,a,s,h){if(!(e instanceof t.Vec3))throw Error("sep normal must be vector");if(!(o instanceof Array))throw Error("world verts must be array");a=Number(a),s=Number(s);for(var c=this,l=[],u=o,p=l,v=-1,d=1/0,y=0;c.faces.length>y;y++){c.faceNormals[y].copy(P),n.vmult(P,P);var f=P.dot(e);d>f&&(d=f,v=y)}if(0>v)return console.log("--- did not find any closest face... ---"),void 0;var m=c.faces[v];m.connectedFaces=[];for(var w=0;c.faces.length>w;w++)for(var b=0;c.faces[w].length>b;b++)-1!==m.indexOf(c.faces[w][b])&&w!==v&&-1===m.connectedFaces.indexOf(w)&&m.connectedFaces.push(w);u.length;for(var x=m.length,g=0;x>g;g++){var V=c.vertices[m[g]],z=c.vertices[m[(g+1)%x]];V.vsub(z,C),C.copy(B),n.vmult(B,B),i.vadd(B,B),this.faceNormals[v].copy(I),n.vmult(I,I),i.vadd(I,I),B.cross(I,O),O.negate(O),V.copy(R),n.vmult(R,R),i.vadd(R,R);var E,N=(-R.dot(O),m.connectedFaces[g]);this.faceNormals[N].copy(A);var S=r(N);A.copy(T),n.vmult(T,T);var E=S-T.dot(i);for(this.clipFaceAgainstPlane(u,p,T,E);u.length;)u.shift();for(;p.length;)u.push(p.shift())}this.faceNormals[v].copy(A);var S=r(v);A.copy(T),n.vmult(T,T);for(var E=S-T.dot(i),w=0;u.length>w;w++){var M=T.dot(u[w])+E;if(a>=M&&(console.log("clamped: depth="+M+" to minDist="+(a+"")),M=a),s>=M){var j=u[w];if(0>=M){var q={point:j,normal:T,depth:M};h.push(q)}}}},this.clipFaceAgainstPlane=function(e,i,n,o){if(!(n instanceof t.Vec3))throw Error("planeNormal must be Vec3, "+n+" given");if(!(e instanceof Array))throw Error("invertices must be Array, "+e+" given");if(!(i instanceof Array))throw Error("outvertices must be Array, "+i+" given");var a,r,s=e.length;if(2>s)return i;var h=e[e.length-1],c=e[0];a=n.dot(h)+o;for(var l=0;s>l;l++){if(c=e[l],r=n.dot(c)+o,0>a)if(0>r){var u=new t.Vec3;c.copy(u),i.push(u)}else{var u=new t.Vec3;h.lerp(c,a/(a-r),u),i.push(u)}else if(0>r){var u=new t.Vec3;h.lerp(c,a/(a-r),u),i.push(u),i.push(c)}h=c,a=r}return i};var s=this;this.calculateLocalInertia=function(t,e){s.computeAABB();var i=this.aabbmax.x-this.aabbmin.x,n=this.aabbmax.y-this.aabbmin.y,o=this.aabbmax.z-this.aabbmin.z;e.x=1/12*t*(2*2*n*n+2*2*o*o),e.y=1/12*t*(2*2*i*i+2*2*o*o),e.z=1/12*t*(2*2*n*n+2*2*i*i)},new t.Vec3,this.computeAABB=function(){var t=this.vertices.length,e=this.aabbmin,i=this.aabbmax,n=this.vertices;e.set(1/0,1/0,1/0),i.set(-1/0,-1/0,-1/0);for(var o=0;t>o;o++){var a=n[o];a.x<e.x?e.x=a.x:a.x>i.x&&(i.x=a.x),a.y<e.y?e.y=a.y:a.y>i.y&&(i.y=a.y),a.z<e.z?e.z=a.z:a.z>i.z&&(i.z=a.z)}}},t.ConvexPolyhedron.prototype=new t.Shape,t.ConvexPolyhedron.prototype.constructor=t.ConvexPolyhedron,t.ConvexPolyhedron.prototype.computeWorldVertices=function(e,i){for(var n=this.vertices.length;n>this.worldVertices.length;)this.worldVertices.push(new t.Vec3);for(var o=this.vertices,a=this.worldVertices,r=0;r!==n;r++)i.vmult(o[r],a[r]),e.vadd(a[r],a[r]);this.worldVerticesNeedsUpdate=!1},t.ConvexPolyhedron.prototype.computeWorldFaceNormals=function(e){for(var i=this.faceNormals.length;i>this.worldFaceNormals.length;)this.worldFaceNormals.push(new t.Vec3);for(var n=this.faceNormals,o=this.worldFaceNormals,a=0;a!==i;a++)e.vmult(n[a],o[a]);this.worldFaceNormalsNeedsUpdate=!1},t.ConvexPolyhedron.prototype.computeBoundingSphereRadius=function(){for(var t=0,e=this.vertices,i=0,n=e.length;i!==n;i++){var o=e[i].norm2();o>t&&(t=o)}this.boundingSphereRadius=Math.sqrt(t),this.boundingSphereRadiusNeedsUpdate=!1};var f=new t.Vec3;t.ConvexPolyhedron.prototype.calculateWorldAABB=function(t,e,i,n){for(var o,a,r,s,h,c,l=this.vertices.length,u=this.vertices,p=0;l>p;p++){u[p].copy(f),e.vmult(f,f),t.vadd(f,f);var v=f;o>v.x||void 0===o?o=v.x:(v.x>s||void 0===s)&&(s=v.x),a>v.y||void 0===a?a=v.y:(v.y>h||void 0===h)&&(h=v.y),r>v.z||void 0===r?r=v.z:(v.z>c||void 0===c)&&(c=v.z)}i.set(o,a,r),n.set(s,h,c)},t.ConvexPolyhedron.prototype.volume=function(){return this.boundingSphereRadiusNeedsUpdate&&this.computeBoundingSphereRadius(),4*Math.PI*this.boundingSphereRadius/3},t.ConvexPolyhedron.prototype.getAveragePointLocal=function(e){e=e||new t.Vec3;for(var i=this.vertices.length,n=this.vertices,o=0;i>o;o++)e.vadd(n[o],e);return e.mult(1/i,e),e},t.ConvexPolyhedron.prototype.transformAllPoints=function(t,e){var i=this.vertices.length,n=this.vertices;if(e){for(var o=0;i>o;o++){var a=n[o];e.vmult(a,a)}for(var o=0;this.faceNormals.length>o;o++){var a=this.faceNormals[o];e.vmult(a,a)}}if(t)for(var o=0;i>o;o++){var a=n[o];a.vadd(t,a)}};var m=new t.Vec3,w=new t.Vec3,b=new t.Vec3;t.ConvexPolyhedron.prototype.pointIsInside=function(t){var e=this.vertices.length,i=this.vertices,n=this.faces,o=this.faceNormals,a=null,r=this.faces.length,s=m;this.getAveragePointLocal(s);for(var h=0;r>h;h++){this.faces[h].length;var e=o[h],c=i[n[h][0]],l=w;t.vsub(c,l);var u=e.dot(l),p=b;s.vsub(c,p);var v=e.dot(p);if(0>u&&v>0||u>0&&0>v)return!1}return a?1:-1},t.Cylinder=function(e,i,n,o){var a=o,r=[],s=[],h=[],c=[],l=[],u=Math.cos,p=Math.sin;r.push(new t.Vec3(i*u(0),i*p(0),.5*-n)),c.push(0),r.push(new t.Vec3(e*u(0),e*p(0),.5*n)),l.push(1);for(var v=0;a>v;v++){var d=2*Math.PI/a*(v+1),y=2*Math.PI/a*(v+.5);a-1>v?(r.push(new t.Vec3(i*u(d),i*p(d),.5*-n)),c.push(2*v+2),r.push(new t.Vec3(e*u(d),e*p(d),.5*n)),l.push(2*v+3),s.push(new t.Vec3(u(y),p(y),0)),h.push([2*v+2,2*v+3,2*v+1,2*v])):(h.push([0,1,2*v+1,2*v]),s.push(new t.Vec3(u(y),p(y),0)))}h.push(l),s.push(new t.Vec3(0,0,1));for(var f=[],v=0;c.length>v;v++)f.push(c[c.length-v-1]);h.push(f),s.push(new t.Vec3(0,0,-1)),this.type=t.Shape.types.CONVEXPOLYHEDRON,t.ConvexPolyhedron.call(this,r,h,s)},t.Cylinder.prototype=new t.ConvexPolyhedron,t.Broadphase=function(){this.world=null,this.useBoundingBoxes=!1},t.Broadphase.prototype.constructor=t.BroadPhase,t.Broadphase.prototype.collisionPairs=function(){throw Error("collisionPairs not implemented for this BroadPhase class!")};var x=t.Body.STATIC|t.Body.KINEMATIC;t.Broadphase.prototype.needBroadphaseCollision=function(e,i){return 0===(e.collisionFilterGroup&i.collisionFilterMask)||0===(i.collisionFilterGroup&e.collisionFilterMask)?!1:0===(e.motionstate&x)&&!e.isSleeping()||0===(i.motionstate&x)&&!i.isSleeping()?e.shape||i.shape?e.shape instanceof t.Plane&&i.shape instanceof t.Plane?!1:!0:!1:!1},t.Broadphase.prototype.intersectionTest=function(t,e,i,n){this.useBoundingBoxes?this.doBoundingBoxBroadphase(t,e,i,n):this.doBoundingSphereBroadphase(t,e,i,n)};var g=new t.Vec3,V=new t.Vec3,z=(new t.Quaternion,new t.Vec3);t.Broadphase.prototype.doBoundingSphereBroadphase=function(e,i,n,o){var a=t.Shape.types,r=a.SPHERE|a.BOX|a.COMPOUND|a.CONVEXPOLYHEDRON,s=a.PLANE;t.Body.STATIC|t.Body.KINEMATIC;var h=g,c=V,l=z,u=e.shape,p=i.shape;if(u&&p){var v=u.type,d=p.type;if(v&r&&d&r){i.position.vsub(e.position,h),u.boundingSphereRadiusNeedsUpdate&&u.computeBoundingSphereRadius(),p.boundingSphereRadiusNeedsUpdate&&p.computeBoundingSphereRadius();var y=u.boundingSphereRadius+p.boundingSphereRadius;y*y>h.norm2()&&(n.push(e),o.push(i))}else if(v&r&&d&a.PLANE||d&r&&v&a.PLANE){var f=v===s?e:i,m=v!==s?e:i,w=m.shape,b=f.shape;m.position.vsub(f.position,h),b.worldNormalNeedsUpdate&&b.computeWorldNormal(f.quaternion),c=b.worldNormal,w.boundingSphereRadiusNeedsUpdate&&w.computeBoundingSphereRadius();var x=h.dot(c)-w.boundingSphereRadius;0>x&&(n.push(e),o.push(i))}}else if(u||p){var E=u?i:e,N=u?e:i,w=N.shape,S=w.type;if(S&r){if(S===a.SPHERE)E.position.vsub(N.position,l),w.radius*w.radius>=l.norm2()&&(n.push(E),o.push(N));else if(S===a.CONVEXPOLYHEDRON||S===a.BOX||S===a.COMPOUND){w.boundingSphereRadiusNeedsUpdate&&w.computeBoundingSphereRadius();var M=w.boundingSphereRadius;E.position.vsub(N.position,l),M*M>=l.norm2()&&(n.push(E),o.push(N))}}else if(S===a.PLANE){var j=N;c.set(0,0,1),j.quaternion.vmult(c,c),E.position.vsub(j.position,l),0>=c.dot(l)&&(n.push(E),o.push(N))}}else;},t.Broadphase.prototype.doBoundingBoxBroadphase=function(e,i,n,o){var a=e.shape,r=i.shape;if(e.aabbNeedsUpdate&&e.computeAABB(),i.aabbNeedsUpdate&&i.computeAABB(),a&&r)e.aabbmax.x<i.aabbmin.x||e.aabbmax.y<i.aabbmin.y||e.aabbmax.z<i.aabbmin.z||e.aabbmin.x>i.aabbmax.x||e.aabbmin.y>i.aabbmax.y||e.aabbmin.z>i.aabbmax.z||(n.push(e),o.push(i));else if(a||r){var s=a?i:e,h=a?e:i;h.shape instanceof t.Plane,s.position.x<h.aabbmin.x||s.position.y<h.aabbmin.y||s.position.z<h.aabbmin.z||s.position.x>h.aabbmax.x||s.position.y>h.aabbmax.y||s.position.z>h.aabbmax.z||(n.push(e),o.push(i))}else;};var E={},N=[],S=[];t.Broadphase.prototype.makePairsUnique=function(t,e){for(var i=E,n=N,o=S,a=t.length,r=0;r!==a;r++)n[r]=t[r],o[r]=e[r];t.length=0,e.length=0;for(var r=0;r!==a;r++){var s=n[r].id,h=o[r].id,c=h>s?s+","+h:h+","+s;i[c]=r}for(var c in i){var r=i[c];t.push(n[r]),e.push(o[r]),delete i[c]}},t.NaiveBroadphase=function(){t.Broadphase.apply(this)},t.NaiveBroadphase.prototype=new t.Broadphase,t.NaiveBroadphase.prototype.constructor=t.NaiveBroadphase,t.NaiveBroadphase.prototype.collisionPairs=function(t,e,i){var n,o,a,r,s=t.bodies,h=s.length;for(n=0;n!==h;n++)for(o=0;o!==n;o++)a=s[n],r=s[o],this.needBroadphaseCollision(a,r)&&this.intersectionTest(a,r,e,i)},t.GridBroadphase=function(e,i,n,o,a){t.Broadphase.apply(this),this.nx=n||10,this.ny=o||10,this.nz=a||10,this.aabbMin=e||new t.Vec3(100,100,100),this.aabbMax=i||new t.Vec3(-100,-100,-100),this.bins=[]},t.GridBroadphase.prototype=new t.Broadphase,t.GridBroadphase.prototype.constructor=t.GridBroadphase;var M=new t.Vec3,j=new t.Vec3;t.GridBroadphase.prototype.collisionPairs=function(e,i,n){var o=e.numObjects(),a=e.bodies,r=this.aabbMax,s=this.aabbMin,h=this.nx,c=this.ny,l=this.nz,u=r.x,p=r.y,v=r.z,d=s.x,y=s.y,f=s.z,m=h/(u-d),w=c/(p-y),b=l/(v-f),x=(u-d)/h,g=(p-y)/c,V=(v-f)/l,z=t.Shape.types,E=z.SPHERE,N=z.PLANE;z.BOX,z.COMPOUND,z.CONVEXPOLYHEDRON;for(var S=this.bins,q=h*c*l,P=S.length-1;P!==q;P++)S.push([]);for(var P=0;P!==q;P++)S[P].length=0;for(var C=Math.floor,P=0;P!==o;P++){var B=a[P],I=B.shape;switch(I.type){case E:for(var O=B.position.x,R=B.position.y,A=B.position.z,T=I.radius,F=C(m*(O-T-d)),k=C(w*(R-T-y)),U=C(b*(A-T-f)),W=C(m*(O+T-d)),L=C(w*(R+T-y)),D=C(b*(A+T-f)),Q=F;Q!==W+1;Q++)for(var H=k;H!==L+1;H++)for(var X=U;X!==D+1;X++){var G=Q,Y=H,_=X,Z=G*(c-1)*(l-1)+Y*(l-1)+_;Z>=0&&q>Z&&S[Z].push(B)}break;case N:var K=M,J=j,$=.25*(x*x+g*g+V*V),te=I.worldNormal;
I.worldNormalNeedsUpdate&&I.computeWorldNormal(B.quaternion);for(var Q=0;Q!==h;Q++)for(var H=0;H!==c;H++)for(var X=0;X!==l;X++){var G=Q,Y=H,_=X;if(J.set(G*x+d,Y*g+y,_*V+f),J.vsub(B.position,K),$>K.dot(te)){var Z=G*(c-1)*(l-1)+Y*(l-1)+_;S[Z].push(B)}}break;default:console.warn("Shape "+I.type+" not supported in GridBroadphase!")}}for(var P=0;P!==q;P++)for(var ee=S[P],Q=0,ie=ee.length;Q!==ie;Q++)for(var B=ee[Q],H=0;H!==Q;H++){var ne=ee[H];this.needBroadphaseCollision(B,ne)&&this.intersectionTest(B,ne,i,n)}this.makePairsUnique(i,n)},t.Solver=function(){this.equations=[]},t.Solver.prototype.solve=function(){return 0},t.Solver.prototype.addEquation=function(t){this.equations.push(t)},t.Solver.prototype.removeEquation=function(t){var e=this.equations,i=e.indexOf(t);-1!==i&&e.splice(i,1)},t.Solver.prototype.removeAllEquations=function(){this.equations.length=0},t.GSSolver=function(){t.Solver.call(this),this.iterations=10,this.tolerance=0},t.GSSolver.prototype=new t.Solver;var q=[],P=[],C=[];t.GSSolver.prototype.solve=function(t,e){var i,n,o,a,r,s,h=(this.d,this.k,0),c=this.iterations,l=this.tolerance*this.tolerance,u=(this.a,this.b),p=this.equations,v=p.length,d=e.bodies,y=d.length,f=t,m=P,w=C,b=q;m.length=0,w.length=0,b.length=0;for(var x=0;x!==v;x++){var g=p[x];g.spookParamsNeedsUpdate&&(g.updateSpookParams(f),g.spookParamsNeedsUpdate=!1),b[x]=0,w[x]=g.computeB(f),m[x]=1/g.computeC()}if(0!==v){for(var x=0;x!==y;x++){var u=d[x],V=u.vlambda,z=u.wlambda;V.set(0,0,0),z&&z.set(0,0,0)}for(h=0;h!==c;h++){a=0;for(var E=0;E!==v;E++){var g=p[E];i=w[E],n=m[E],s=b[E],r=g.computeGWlambda(),o=n*(i-r-g.eps*s),g.minForce>s+o?o=g.minForce-s:s+o>g.maxForce&&(o=g.maxForce-s),b[E]+=o,a+=o>0?o:-o,g.addToWlambda(o)}if(l>a*a)break}for(var x=0;x!==y;x++){var u=d[x],N=u.velocity,S=u.angularVelocity;N.vadd(u.vlambda,N),S&&S.vadd(u.wlambda,S)}}return h},t.SplitSolver=function(e){t.Solver.call(this),this.subsolver=e},t.SplitSolver.prototype=new t.Solver;var B=[],I=[],O=[],R={bodies:null};t.SplitSolver.prototype.solve=function(e,i){function n(t){for(var e=t.length,i=0;i!==e;i++){var n=t[i];if(!(n.visited||n.body.motionstate&x))return n}return!1}function o(t,e){var i=[];for(i.push(t),t.visited=!0,e(t);i.length;)for(var o,a=i.pop();o=n(a.children);)o.visited=!0,e(o),i.push(o)}function a(t){z.push(t.body);for(var e=t.eqs.length,i=0;i!==e;i++){var n=t.eqs[i];-1===V.indexOf(n)&&V.push(n)}}for(var r=B,s=i.bodies,h=this.equations,c=h.length,l=s.length,u=this.subsolver,p=r.length;p!==l;p++)r.push({body:s[p],children:[],eqs:[],visited:!1});for(var p=0;p!==l;p++){var v=r[p];v.body=s[p],v.children.length=0,v.eqs.length=0,v.visited=!1}for(var d=0;d!==c;d++){var y=h[d],p=s.indexOf(y.bi),f=s.indexOf(y.bj),m=r[p],w=r[f];m.children.push(w),m.eqs.push(y),w.children.push(m),w.eqs.push(y)}for(var b,x=t.Body.STATIC,g=0,V=I,z=O,E=R;b=n(r);){V.length=0,z.length=0,o(b,a);for(var N=V.length,p=0;p!==N;p++)u.addEquation(V[p]);E.bodies=z,u.solve(e,E),u.removeAllEquations(),g++}return g},t.Material=function(t){this.name=t,this.id=-1},t.ContactMaterial=function(t,e,i,n){this.id=-1,this.materials=[t,e],this.friction=void 0!==i?Number(i):.3,this.restitution=void 0!==n?Number(n):.3,this.contactEquationStiffness=1e7,this.contactEquationRegularizationTime=3,this.frictionEquationStiffness=1e7,this.frictionEquationRegularizationTime=3},t.World=function(){t.EventTarget.apply(this),this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.last_dt=this.default_dt,this.nextId=0,this.gravity=new t.Vec3,this.broadphase=null,this.bodies=[],this.solver=new t.GSSolver,this.constraints=[],this.contactgen=new t.ContactGenerator,this.collision_matrix=[],this.materials=[],this.contactmaterials=[],this.mats2cmat=[],this.defaultMaterial=new t.Material("default"),this.defaultContactMaterial=new t.ContactMaterial(this.defaultMaterial,this.defaultMaterial,.3,0),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,nearphase:0}},t.World.prototype.getContactMaterial=function(e,i){if(e instanceof t.Material&&i instanceof t.Material){var n=e.id,o=i.id;if(o>n){var a=n;n=o,o=a}return this.contactmaterials[this.mats2cmat[n+o*this.materials.length]]}},t.World.prototype.numObjects=function(){return this.bodies.length},t.World.prototype.collisionMatrixGet=function(t,e,i){var n=this.bodies.length;if(void 0===i&&(i=!0),i&&e>t||!i&&t>e){var o=e;e=t,t=o}return this.collision_matrix[t+e*n]},t.World.prototype.collisionMatrixSet=function(t,e,i,n){var o=this.bodies.length;if(void 0===n&&(n=!0),n&&e>t||!n&&t>e){var a=e;e=t,t=a}this.collision_matrix[t+e*o]=i},t.World.prototype.collisionMatrixTick=function(){var t,e,i,n=this.bodies.length;for(e=0;e!==n;e++)for(i=0;i!==e;i++)t=this.collisionMatrixGet(e,i,!0),this.collisionMatrixSet(e,i,t,!1),this.collisionMatrixSet(e,i,0,!0)},t.World.prototype.add=function(e){var i=this.numObjects();this.bodies.push(e),e.id=this.id(),e.world=this,e.position.copy(e.initPosition),e.velocity.copy(e.initVelocity),e.timeLastSleepy=this.time,e instanceof t.RigidBody&&(e.angularVelocity.copy(e.initAngularVelocity),e.quaternion.copy(e.initQuaternion));for(var n=0;2*i+1>n;n++)this.collision_matrix.push(0)},t.World.prototype.addConstraint=function(t){this.constraints.push(t),t.id=this.id()},t.World.prototype.removeConstraint=function(t){var e=this.constraints.indexOf(t);-1!==e&&this.constraints.splice(e,1)},t.World.prototype.id=function(){return this.nextId++},t.World.prototype.remove=function(t){t.world=null;var e,i=this.numObjects(),n=this.bodies;for(e=0;e!==n.length;e++)if(n[e].id===t.id){n.splice(e,1);break}for(e=0;e!==2*i-1;e++)this.collision_matrix.pop()},t.World.prototype.addMaterial=function(t){if(-1===t.id){var e=this.materials.length;this.materials.push(t),t.id=this.materials.length-1;for(var i=0;i!==2*e+1;i++)this.mats2cmat.push(-1)}},t.World.prototype.addContactMaterial=function(t){this.addMaterial(t.materials[0]),this.addMaterial(t.materials[1]);var e,i;t.materials[0].id>t.materials[1].id?(e=t.materials[0].id,i=t.materials[1].id):(i=t.materials[0].id,e=t.materials[1].id),this.contactmaterials.push(t),t.id=this.contactmaterials.length-1,this.mats2cmat[e+this.materials.length*i]=t.id},t.World.prototype._now=function(){return window.performance.webkitNow?window.performance.webkitNow():Date.now()};var A={type:"postStep"},T={type:"collide","with":null,contact:null},F=[],k=[],U=[],W=[],L=new t.Vec3,D=(new t.Vec3,new t.Vec3,new t.Vec3,new t.Vec3,new t.Vec3,new t.Vec3,new t.Vec3,new t.Vec3,new t.Quaternion,new t.Quaternion),Q=new t.Quaternion;t.World.prototype.step=function(e){var i,n=this.contacts,o=U,a=W,r=this.numObjects(),s=this.bodies,h=this.solver,c=this.gravity,l=this.doProfiling,u=this.profile,p=t.Body.DYNAMIC,v=this._now,d=this.collision_matrix,y=this.constraints,f=t.FrictionEquation,m=k,w=c.norm(),b=c.x,x=c.y,g=c.z,V=0;for(l&&(i=v()),void 0===e&&(e=this.last_dt||this.default_dt),V=0;V!==r;V++){var z=s[V];if(z.motionstate&p){var E=z.force,N=z.mass;E.x+=N*b,E.y+=N*x,E.z+=N*g}}l&&(i=v()),o.length=0,a.length=0,this.broadphase.collisionPairs(this,o,a),l&&(u.broadphase=v()-i),this.collisionMatrixTick(),l&&(i=v());var S=F,M=n.length;for(V=0;V!==M;V++)S.push(n[V]);n.length=0,this.contactgen.getContacts(o,a,this,n,S),l&&(u.nearphase=v()-i),l&&(i=v());var j=n.length,q=this.frictionEquations.length;for(V=0;V!==q;V++)m.push(this.frictionEquations[V]);this.frictionEquations.length=0;for(var P=0;P!==j;P++){var C=n[P],z=C.bi,B=C.bj,V=s.indexOf(z),I=s.indexOf(B),d=this.getContactMaterial(z.material,B.material)||this.defaultContactMaterial,O=d.friction;d.restitution;var R=L;R.set(B.position.x+C.rj.x-z.position.x-C.ri.x,B.position.y+C.rj.y-z.position.y-C.ri.y,B.position.z+C.rj.z-z.position.z-C.ri.z);var H=R.dot(C.ni);if(0>H){if(C.restitution=d.restitution,C.penetration=H,C.stiffness=d.contactEquationStiffness,C.regularizationTime=d.contactEquationRegularizationTime,h.addEquation(C),O>0){var X=O*w,G=z.invMass+B.invMass;G>0&&(G=1/G);var Y=m,_=Y.length?Y.pop():new f(z,B,X*G),Z=Y.length?Y.pop():new f(z,B,X*G);this.frictionEquations.push(_),this.frictionEquations.push(Z),_.bi=Z.bi=z,_.bj=Z.bj=B,_.minForce=Z.minForce=-X*G,_.maxForce=Z.maxForce=X*G,C.ri.copy(_.ri),C.rj.copy(_.rj),C.ri.copy(Z.ri),C.rj.copy(Z.rj),C.ni.tangents(_.t,Z.t),h.addEquation(_),h.addEquation(Z)}this.collisionMatrixSet(V,I,1,!0),this.collisionMatrixGet(V,I,!0)!==this.collisionMatrixGet(V,I,!1)&&(T.with=B,T.contact=C,z.dispatchEvent(T),T.with=z,B.dispatchEvent(T),z.wakeUp(),B.wakeUp())}}l&&(u.makeContactConstraints=v()-i),l&&(i=v());var K=y.length;for(V=0;V!==K;V++){var C=y[V];C.update();for(var I=0,J=C.equations.length;I!==J;I++){var $=C.equations[I];h.addEquation($)}}h.solve(e,this),l&&(u.solve=v()-i),h.removeAllEquations();var te=Math.pow;for(V=0;V!==r;V++){var z=s[V];if(z.motionstate&p){var ee=te(1-z.linearDamping,e),ie=z.velocity;ie.mult(ee,ie);var ne=z.angularVelocity;if(ne){var oe=te(1-z.angularDamping,e);ne.mult(oe,ne)}}}for(this.dispatchEvent(A),V=0;V!==r;V++){var z=s[V];z.preStep&&z.preStep.call(z)}l&&(i=v());var ae=D,re=Q,se=this.stepnumber,he=t.Body.DYNAMIC|t.Body.KINEMATIC,ce=0===se%(this.quatNormalizeSkip+1),le=this.quatNormalizeFast,ue=.5*e,pe=t.Shape.types.PLANE,ve=t.Shape.types.CONVEXPOLYHEDRON;for(V=0;V!==r;V++){var de=s[V],ye=de.shape,fe=de.force,me=de.tau;if(de.motionstate&he){var we=de.velocity,be=de.angularVelocity,xe=de.position,ge=de.quaternion,Ve=de.invMass,ze=de.invInertia;if(we.x+=fe.x*Ve*e,we.y+=fe.y*Ve*e,we.z+=fe.z*Ve*e,de.angularVelocity&&(be.x+=me.x*ze.x*e,be.y+=me.y*ze.y*e,be.z+=me.z*ze.z*e),de.isSleeping()||(xe.x+=we.x*e,xe.y+=we.y*e,xe.z+=we.z*e,de.angularVelocity&&(ae.set(be.x,be.y,be.z,0),ae.mult(ge,re),ge.x+=ue*re.x,ge.y+=ue*re.y,ge.z+=ue*re.z,ge.w+=ue*re.w,ce&&(le?ge.normalizeFast():ge.normalize())),de.aabbmin&&(de.aabbNeedsUpdate=!0)),ye)switch(ye.type){case pe:ye.worldNormalNeedsUpdate=!0;break;case ve:ye.worldFaceNormalsNeedsUpdate=!0,ye.worldVerticesNeedsUpdate=!0}}de.force.set(0,0,0),de.tau&&de.tau.set(0,0,0)}for(l&&(u.integrate=v()-i),this.time+=e,this.stepnumber+=1,this.dispatchEvent(A),V=0;V!==r;V++){var z=s[V],Ee=z.postStep;Ee&&Ee.call(z)}for(V=0;V!==r;V++){var de=s[V];de.inertiaWorldAutoUpdate&&de.quaternion.vmult(de.inertia,de.inertiaWorld),de.invInertiaWorldAutoUpdate&&de.quaternion.vmult(de.invInertia,de.invInertiaWorld)}if(this.allowSleep)for(V=0;V!==r;V++)s[V].sleepTick(this.time)},t.ContactGenerator=function(){function e(e,i){if(f.length){var n=f.pop();return n.bi=e,n.bj=i,n}return new t.ContactEquation(e,i)}function i(t){var e;e=t.ri,t.ri=t.rj,t.rj=e,t.ni.negate(t.ni),e=t.bi,t.bi=t.bj,t.bj=e}function n(t,i,n,o,a,r,s,h,c){var l=e(h,c);c.position.vsub(o,l.ni),l.ni.normalize(),l.ni.copy(l.ri),l.ni.copy(l.rj),l.ri.mult(i.radius,l.ri),l.rj.mult(-n.radius,l.rj),t.push(l)}function o(t,i,n,o,a,r,s,h,c){var l=e(h,c);l.ni.set(0,0,1),s.vmult(l.ni,l.ni),l.ni.negate(l.ni),l.ni.normalize(),l.ni.mult(i.radius,l.ri),o.vsub(a,w),l.ni.mult(l.ni.dot(w),b),w.vsub(b,l.rj),b.norm2()<=i.radius*i.radius&&t.push(l)}function a(t,e,i){for(var n=null,o=t.length,a=0;a!==o;a++){var r=t[a],s=x;t[(a+1)%o].vsub(r,s);var h=g;s.cross(e,h);var c=V;i.vsub(r,c);var l=h.dot(c);if(!(null===n||l>0&&n===!0||0>=l&&n===!1))return!1;null===n&&(n=l>0)}return!0}function r(t,i,n,o,a,r,s,h,c){var l=M;o.vsub(a,z),n.getSideNormals(l,s);for(var u=i.radius,p=!1,v=q,d=P,y=C,f=null,w=0,b=0,x=0,g=null,V=0,B=l.length;V!==B&&p===!1;V++){var I=E;l[V].copy(I);var O=I.norm();I.normalize();var R=z.dot(I);if(O+u>R&&R>0){var A=N,T=S;l[(V+1)%3].copy(A),l[(V+2)%3].copy(T);var F=A.norm(),k=T.norm();A.normalize(),T.normalize();var U=z.dot(A),W=z.dot(T);if(F>U&&U>-F&&k>W&&W>-k){var L=Math.abs(R-O-u);(null===g||g>L)&&(g=L,b=U,x=W,f=O,I.copy(v),A.copy(d),T.copy(y),w++)}}}if(w){p=!0;var D=e(h,c);v.mult(-u,D.ri),v.copy(D.ni),D.ni.negate(D.ni),v.mult(f,v),d.mult(b,d),v.vadd(d,v),y.mult(x,y),v.vadd(y,D.rj),t.push(D)}for(var Q=m.get(),H=j,X=0;2!==X&&!p;X++)for(var G=0;2!==G&&!p;G++)for(var Y=0;2!==Y&&!p;Y++)if(Q.set(0,0,0),X?Q.vadd(l[0],Q):Q.vsub(l[0],Q),G?Q.vadd(l[1],Q):Q.vsub(l[1],Q),Y?Q.vadd(l[2],Q):Q.vsub(l[2],Q),a.vadd(Q,H),H.vsub(o,H),u*u>H.norm2()){p=!0;var D=e(h,c);H.copy(D.ri),D.ri.normalize(),D.ri.copy(D.ni),D.ri.mult(u,D.ri),Q.copy(D.rj),t.push(D)}m.release(Q),Q=null;for(var _=m.get(),Z=m.get(),D=m.get(),K=m.get(),L=m.get(),J=l.length,X=0;X!==J&&!p;X++)for(var G=0;G!==J&&!p;G++)if(X%3!==G%3){l[G].cross(l[X],_),_.normalize(),l[X].vadd(l[G],Z),o.copy(D),D.vsub(Z,D),D.vsub(a,D);var $=D.dot(_);_.mult($,K);for(var Y=0;Y===X%3||Y===G%3;)Y++;o.copy(L),L.vsub(K,L),L.vsub(Z,L),L.vsub(a,L);var te=Math.abs($),ee=L.norm();if(l[Y].norm()>te&&u>ee){p=!0;var ie=e(h,c);Z.vadd(K,ie.rj),ie.rj.copy(ie.rj),L.negate(ie.ni),ie.ni.normalize(),ie.rj.copy(ie.ri),ie.ri.vadd(a,ie.ri),ie.ri.vsub(o,ie.ri),ie.ri.normalize(),ie.ri.mult(u,ie.ri),t.push(ie)}}m.release(_,Z,D,K,L)}function s(t,i,n,o,r,s,h,c,l){o.vsub(r,B);for(var u=n.faceNormals,p=n.faces,v=n.vertices,d=i.radius,y=0;y!==v.length;y++){var f=v[y],w=A;h.vmult(f,w),r.vadd(w,w);var b=R;if(w.vsub(o,b),d*d>b.norm2()){g=!0;var x=e(c,l);return b.copy(x.ri),x.ri.normalize(),x.ri.copy(x.ni),x.ri.mult(d,x.ri),w.vsub(r,x.rj),t.push(x),void 0}}for(var g=!1,y=0,V=p.length;y!==V&&g===!1;y++){var z=u[y],E=p[y],N=T;h.vmult(z,N);var S=F;h.vmult(v[E[0]],S),S.vadd(r,S);var M=k;N.mult(-d,M),o.vadd(M,M);var j=U;M.vsub(S,j);var q=j.dot(N),P=W;if(o.vsub(S,P),0>q&&P.dot(N)>0){for(var C=[],L=0,D=E.length;L!==D;L++){var Q=m.get();h.vmult(v[E[L]],Q),r.vadd(Q,Q),C.push(Q)}if(a(C,N,o)){g=!0;var x=e(c,l);N.mult(-d,x.ri),N.negate(x.ni);var H=m.get();N.mult(-q,H);var X=m.get();N.mult(-d,X),o.vsub(r,x.rj),x.rj.vadd(X,x.rj),x.rj.vadd(H,x.rj),m.release(H),m.release(X),t.push(x);for(var L=0,G=C.length;L!==G;L++)m.release(C[L]);return}for(var L=0;L!==E.length;L++){var Y=m.get(),_=m.get();h.vmult(v[E[(L+1)%E.length]],Y),h.vmult(v[E[(L+2)%E.length]],_),r.vadd(Y,Y),r.vadd(_,_);var Z=I;_.vsub(Y,Z);var K=O;Z.unit(K);var J=m.get(),$=m.get();o.vsub(Y,$);var te=$.dot(K);K.mult(te,J),J.vadd(Y,J);var ee=m.get();if(J.vsub(o,ee),te>0&&Z.norm2()>te*te&&d*d>ee.norm2()){var x=e(c,l);J.vsub(r,x.rj),J.vsub(o,x.ni),x.ni.normalize(),x.ni.mult(d,x.ri),t.push(x);for(var L=0,G=C.length;L!==G;L++)m.release(C[L]);return m.release(Y),m.release(_),m.release(J),m.release(ee),m.release($),void 0}m.release(Y),m.release(_),m.release(J),m.release(ee),m.release($)}for(var L=0,G=C.length;L!==G;L++)m.release(C[L])}}}function h(t,e,i,n,o,a,r,s,h){l(t,e,i.convexPolyhedronRepresentation,n,o,a,r,s,h)}function c(e,i,n,o,a,r,s,h,c){for(var l=L,u=D,p=0,v=0,d=n.childShapes.length;v!==d;v++){var f=[],m=u.pop()||new t.Quaternion,w=l.pop()||new t.Vec3;s.mult(n.childOrientations[v],m),m.normalize(),s.vmult(n.childOffsets[v],w),a.vadd(w,w),y(f,i,n.childShapes[v],o,w,r,m,h,c),u.push(m);var b=w;i||(p+=f.length);for(var x=0;x!==f.length;x++)s.vmult(n.childOffsets[v],b),f[x].rj.vadd(b,f[x].rj),e.push(f[x]);l.push(w)}}function l(t,i,n,o,a,r,s,h,c){var l=Q,u=H;u.set(0,0,1),r.vmult(u,u);for(var p=X,v=0;v!==n.vertices.length;v++){n.vertices[v].copy(l),s.vmult(l,l),a.vadd(l,l),l.vsub(o,p);var d=u.dot(p);if(0>=d){var y=G;u.mult(u.dot(l),y),l.vsub(y,y);var f=e(h,c);u.copy(f.ni),y.copy(f.ri),l.vsub(a,f.rj),t.push(f)}}}function u(t,i,n,o,a,r,s,h,c){var l=Y;if(i.findSeparatingAxis(n,o,r,a,s,l)){var u=[],p=_;i.clipAgainstHull(o,r,n,a,s,l,-100,100,u);for(var v=0;v!==u.length;v++){var d=e(h,c);l.negate(d.ni),u[v].normal.negate(p),p.mult(u[v].depth,p),u[v].point.vadd(p,d.ri),u[v].point.copy(d.rj),d.rj.vsub(a,d.rj),d.ri.vsub(o,d.ri),t.push(d)}}}function p(t,i,n,o,a,r,s,h,c){var l=Z;l.set(0,0,1),c.quaternion.vmult(l,l);var u=K;o.vsub(c.position,u);var p=l.dot(u);if(0>=p){var v=e(h,c);l.copy(v.ni),v.ni.negate(v.ni),v.ri.set(0,0,0);var d=J;l.mult(l.dot(o),d),o.vsub(d,d),d.copy(v.rj),t.push(v)}}function v(t,i,n,o,a,r,s,h,c){var l=$;l.set(0,0,1),o.vsub(a,l);var u=l.norm2();if(n.radius*n.radius>=u){var p=e(h,c);l.normalize(),l.copy(p.rj),p.rj.mult(n.radius,p.rj),l.copy(p.ni),p.ni.negate(p.ni),p.ri.set(0,0,0),t.push(p)}}function d(t,i,n,o,a,r,s,h,c){var l=-1,u=ie,p=oe,v=null,d=0,y=ee;if(o.copy(y),y.vsub(a,y),s.conjugate(te),te.vmult(y,y),n.pointIsInside(y)){n.worldVerticesNeedsUpdate&&n.computeWorldVertices(a,s),n.worldFaceNormalsNeedsUpdate&&n.computeWorldFaceNormals(s);for(var f=0,m=n.faces.length;f!==m;f++){var w=[n.worldVertices[n.faces[f][0]]],b=n.worldFaceNormals[f];o.vsub(w[0],ne);var x=-b.dot(ne);(null===v||Math.abs(x)<Math.abs(v))&&(v=x,l=f,b.copy(u),d++)}if(-1!==l){var g=e(h,c);u.mult(v,p),p.vadd(o,p),p.vsub(a,p),p.copy(g.rj),u.negate(g.ni),g.ri.set(0,0,0),t.push(g)}else console.warn("Point found inside convex, but did not find penetrating face!")}}function y(e,a,f,m,w,b,x,g,V){var z=!1,E=t.Shape.types,N=E.SPHERE,S=E.PLANE,M=E.BOX,j=E.COMPOUND,q=E.CONVEXPOLYHEDRON;if(a&&f){if(a.type>f.type){var P;P=f,f=a,a=P,P=w,w=m,m=P,P=x,x=b,b=P,P=V,V=g,g=P,z=!0}}else if(a&&!f){var P;P=f,f=a,a=P,P=w,w=m,m=P,P=x,x=b,b=P,P=V,V=g,g=P,z=!0}if(a&&f){if(a.type===N)switch(f.type){case N:n(e,a,f,m,w,b,x,g,V);break;case S:o(e,a,f,m,w,b,x,g,V);break;case M:r(e,a,f,m,w,b,x,g,V);break;case j:c(e,a,f,m,w,b,x,g,V);break;case q:s(e,a,f,m,w,b,x,g,V);break;default:console.warn("Collision between CANNON.Shape.types.SPHERE and "+f.type+" not implemented yet.")}else if(a.type===E.PLANE)switch(f.type){case E.PLANE:throw Error("Plane-plane collision... wait, you did WHAT?");case E.BOX:h(e,a,f,m,w,b,x,g,V);break;case E.COMPOUND:c(e,a,f,m,w,b,x,g,V);break;case E.CONVEXPOLYHEDRON:l(e,a,f,m,w,b,x,g,V);break;default:console.warn("Collision between CANNON.Shape.types.PLANE and "+f.type+" not implemented yet.")}else if(a.type===E.BOX)switch(f.type){case E.BOX:y(e,a.convexPolyhedronRepresentation,f.convexPolyhedronRepresentation,m,w,b,x,g,V);break;case E.COMPOUND:c(e,a,f,m,w,b,x,g,V);break;case E.CONVEXPOLYHEDRON:y(e,a.convexPolyhedronRepresentation,f,m,w,b,x,g,V);break;default:console.warn("Collision between CANNON.Shape.types.BOX and "+f.type+" not implemented yet.")}else if(a.type===E.COMPOUND)switch(f.type){case E.COMPOUND:c(e,a,f,m,w,b,x,g,V);break;case E.CONVEXPOLYHEDRON:var C=[];c(C,f,a,w,m,x,b,V,g);for(var B=0;B!==C.length;B++)i(C[B]),e.push(C[B]);break;default:console.warn("Collision between CANNON.Shape.types.COMPOUND and "+f.type+" not implemented yet.")}else if(a.type===E.CONVEXPOLYHEDRON)switch(f.type){case E.CONVEXPOLYHEDRON:u(e,a,f,m,w,b,x,g,V);break;default:console.warn("Collision between CANNON.Shape.types.CONVEXPOLYHEDRON and "+f.type+" not implemented yet.")}}else switch(f.type){case E.PLANE:p(e,a,f,m,w,b,x,g,V);break;case E.SPHERE:v(e,a,f,m,w,b,x,g,V);break;case E.BOX:d(e,a,f.convexPolyhedronRepresentation,m,w,b,x,g,V);break;case E.CONVEXPOLYHEDRON:d(e,a,f,m,w,b,x,g,V);break;case E.COMPOUND:c(e,a,f,m,w,b,x,g,V);break;default:console.warn("Collision between CANNON.Particle and "+f.type+" not implemented yet.")}for(var I=0,O=e.length;z&&I!==O;I++)i(e[I])}this.contactReduction=!1;var f=[],m=new t.Vec3Pool,w=new t.Vec3,b=new t.Vec3,x=new t.Vec3,g=new t.Vec3,V=new t.Vec3,z=new t.Vec3,E=new t.Vec3,N=new t.Vec3,S=new t.Vec3,M=[new t.Vec3,new t.Vec3,new t.Vec3,new t.Vec3,new t.Vec3,new t.Vec3],j=new t.Vec3,q=new t.Vec3,P=new t.Vec3,C=new t.Vec3,B=new t.Vec3,I=new t.Vec3,O=new t.Vec3,R=new t.Vec3,A=new t.Vec3,T=new t.Vec3,F=new t.Vec3,k=new t.Vec3,U=new t.Vec3,W=new t.Vec3;new t.Vec3,new t.Vec3;var L=[],D=[],Q=new t.Vec3,H=new t.Vec3,X=new t.Vec3,G=new t.Vec3,Y=new t.Vec3,_=new t.Vec3,Z=new t.Vec3,K=new t.Vec3,J=new t.Vec3,$=new t.Vec3,te=new t.Quaternion,ee=new t.Vec3;new t.Vec3;var ie=new t.Vec3,ne=new t.Vec3,oe=new t.Vec3;this.reduceContacts=function(){},this.getContacts=function(t,e,i,n,o){f=o;for(var a=0,r=t.length;a!==r;a++){var s=t[a],h=e[a];y(n,s.shape,h.shape,s.position,h.position,s.quaternion,h.quaternion,s,h)}}},t.Equation=function(t,e,i,n){this.id=-1,this.minForce=i===void 0?-1e6:i,this.maxForce=n===void 0?1e6:n,this.bi=t,this.bj=e,this.stiffness=1e7,this.regularizationTime=5,this.a=0,this.b=0,this.eps=0,this.spookParamsNeedsUpdate=!0},t.Equation.prototype.constructor=t.Equation,t.Equation.prototype.updateSpookParams=function(t){var e=this.regularizationTime,i=this.stiffness;this.a=4/(t*(1+4*e)),this.b=4*e/(1+4*e),this.eps=4/(t*t*i*(1+4*e))},t.ContactEquation=function(e,i){t.Equation.call(this,e,i,0,1e6),this.restitution=0,this.ri=new t.Vec3,this.penetrationVec=new t.Vec3,this.rj=new t.Vec3,this.ni=new t.Vec3,this.rixn=new t.Vec3,this.rjxn=new t.Vec3,this.invIi=new t.Mat3,this.invIj=new t.Mat3,this.biInvInertiaTimesRixn=new t.Vec3,this.bjInvInertiaTimesRjxn=new t.Vec3},t.ContactEquation.prototype=new t.Equation,t.ContactEquation.prototype.constructor=t.ContactEquation,t.ContactEquation.prototype.reset=function(){this.invInertiaTimesRxnNeedsUpdate=!0};var H=new t.Vec3,X=new t.Vec3,G=new t.Vec3;t.ContactEquation.prototype.computeB=function(t){var e=this.a,i=this.b,n=this.bi,o=this.bj,a=this.ri,r=this.rj,s=this.rixn,h=this.rjxn,c=G,l=n.velocity,u=n.angularVelocity?n.angularVelocity:c,p=n.force,v=n.tau?n.tau:c,d=o.velocity,y=o.angularVelocity?o.angularVelocity:c,f=o.force,m=o.tau?o.tau:c,w=this.penetrationVec,b=n.invMass,x=o.invMass,g=this.invIi,V=this.invIj;n.invInertia?g.setTrace(n.invInertia):g.identity(),o.invInertia?V.setTrace(o.invInertia):V.identity();var z=this.ni;a.cross(z,s),r.cross(z,h);var w=this.penetrationVec;w.set(0,0,0),w.vadd(o.position,w),w.vadd(r,w),w.vsub(n.position,w),w.vsub(a,w);var E=z.dot(w),N=H,S=X;g.vmult(v,N),V.vmult(m,S);var M=this.restitution+1,j=M*d.dot(z)-M*l.dot(z)+y.dot(h)-u.dot(s),q=f.dot(z)*x-p.dot(z)*b+h.dot(S)-s.dot(N),P=-E*e-j*i-t*q;return P},new t.Vec3,new t.Vec3,t.ContactEquation.prototype.computeC=function(){var t=this.bi,e=this.bj,i=this.rixn,n=this.rjxn,o=t.invMass,a=e.invMass,r=o+a+this.eps,s=this.invIi,h=this.invIj;return s.vmult(i,this.biInvInertiaTimesRixn),h.vmult(n,this.bjInvInertiaTimesRjxn),r+=this.biInvInertiaTimesRixn.dot(i),r+=this.bjInvInertiaTimesRjxn.dot(n)};var Y=new t.Vec3;t.ContactEquation.prototype.computeGWlambda=function(){var t=this.bi,e=this.bj,i=Y,n=0;return e.vlambda.vsub(t.vlambda,i),n+=i.dot(this.ni),t.wlambda&&(n-=t.wlambda.dot(this.rixn)),e.wlambda&&(n+=e.wlambda.dot(this.rjxn)),n};var _=new t.Vec3,Z=new t.Vec3;t.ContactEquation.prototype.addToWlambda=function(t){var e=this.bi,i=this.bj,n=(this.rixn,this.rjxn,e.invMass),o=i.invMass,a=this.ni,r=_,s=Z;a.mult(n*t,s),e.vlambda.vsub(s,e.vlambda),a.mult(o*t,s),i.vlambda.vadd(s,i.vlambda),void 0!==e.wlambda&&(this.biInvInertiaTimesRixn.mult(t,r),e.wlambda.vsub(r,e.wlambda)),void 0!==i.wlambda&&(this.bjInvInertiaTimesRjxn.mult(t,r),i.wlambda.vadd(r,i.wlambda))},t.FrictionEquation=function(e,i,n){t.Equation.call(this,e,i,-n,n),this.ri=new t.Vec3,this.rj=new t.Vec3,this.t=new t.Vec3,this.rixt=new t.Vec3,this.rjxt=new t.Vec3,this.wixri=new t.Vec3,this.wjxrj=new t.Vec3,this.invIi=new t.Mat3,this.invIj=new t.Mat3,this.relVel=new t.Vec3,this.relForce=new t.Vec3,this.biInvInertiaTimesRixt=new t.Vec3,this.bjInvInertiaTimesRjxt=new t.Vec3},t.FrictionEquation.prototype=new t.Equation,t.FrictionEquation.prototype.constructor=t.FrictionEquation;var K=new t.Vec3,J=new t.Vec3,$=new t.Vec3;t.FrictionEquation.prototype.computeB=function(t){var e=this.a,i=this.b,n=this.bi,o=this.bj,a=this.ri,r=this.rj,s=this.rixt,h=this.rjxt,c=this.wixri,l=this.wjxrj,u=$,p=n.velocity,v=n.angularVelocity?n.angularVelocity:u,d=n.force,y=n.tau?n.tau:u,f=o.velocity,m=o.angularVelocity?o.angularVelocity:u,w=o.force,b=o.tau?o.tau:u,x=(this.relVel,this.relForce,n.invMass),g=o.invMass,V=this.invIi,z=this.invIj,E=this.t,N=K,S=J;n.invInertia&&V.setTrace(n.invInertia),o.invInertia&&z.setTrace(o.invInertia),a.cross(E,s),r.cross(E,h),v.cross(a,c),m.cross(r,l),V.vmult(y,N),z.vmult(b,S);var M=0,j=f.dot(E)-p.dot(E)+l.dot(E)-c.dot(E),q=w.dot(E)*g-d.dot(E)*x+h.dot(S)-s.dot(N),P=-M*e-j*i-t*q;return P},t.FrictionEquation.prototype.computeC=function(){var t=this.bi,e=this.bj,i=this.rixt,n=this.rjxt,o=t.invMass,a=e.invMass,r=o+a+this.eps,s=this.invIi,h=this.invIj;return s.vmult(i,this.biInvInertiaTimesRixt),h.vmult(n,this.bjInvInertiaTimesRjxt),r+=this.biInvInertiaTimesRixt.dot(i),r+=this.bjInvInertiaTimesRjxt.dot(n)};var te=new t.Vec3;t.FrictionEquation.prototype.computeGWlambda=function(){var t=this.bi,e=this.bj,i=0,n=te;return e.vlambda.vsub(t.vlambda,n),i+=n.dot(this.t),t.wlambda&&(i-=t.wlambda.dot(this.rixt)),e.wlambda&&(i+=e.wlambda.dot(this.rjxt)),i};var ee=new t.Vec3;t.FrictionEquation.prototype.addToWlambda=function(t){var e=this.bi,i=this.bj,n=(this.rixt,this.rjxt,e.invMass),o=i.invMass,a=this.t,r=ee,s=e.wlambda,h=i.wlambda;a.mult(n*t,r),e.vlambda.vsub(r,e.vlambda),a.mult(o*t,r),i.vlambda.vadd(r,i.vlambda),s&&(this.biInvInertiaTimesRixt.mult(t,r),s.vsub(r,s)),h&&(this.bjInvInertiaTimesRjxt.mult(t,r),h.vadd(r,h))},t.RotationalEquation=function(e,i){t.Equation.call(this,e,i,-1e6,1e6),this.ni=new t.Vec3,this.nj=new t.Vec3,this.nixnj=new t.Vec3,this.njxni=new t.Vec3,this.invIi=new t.Mat3,this.invIj=new t.Mat3,this.relVel=new t.Vec3,this.relForce=new t.Vec3},t.RotationalEquation.prototype=new t.Equation,t.RotationalEquation.prototype.constructor=t.RotationalEquation,t.RotationalEquation.prototype.computeB=function(e){var i=this.a,n=this.b,o=this.bi,a=this.bj,r=this.ni,s=this.nj,h=this.nixnj,c=this.njxni;o.velocity;var l=o.angularVelocity?o.angularVelocity:new t.Vec3;o.force,o.tau?o.tau:new t.Vec3,a.velocity;var u=a.angularVelocity?a.angularVelocity:new t.Vec3;a.force,a.tau?a.tau:new t.Vec3,o.invMass,a.invMass;var p=this.invIi,v=this.invIj;o.invInertia?p.setTrace(o.invInertia):p.identity(),a.invInertia?v.setTrace(a.invInertia):v.identity(),r.cross(s,h),s.cross(r,c);var d=-r.dot(s),y=c.dot(l)+h.dot(u),f=0,m=-d*i-y*n-e*f;return m},t.RotationalEquation.prototype.computeC=function(){var t=this.bi,e=this.bj,i=this.nixnj,n=this.njxni;t.invMass,e.invMass;var o=this.eps,a=this.invIi,r=this.invIj;return t.invInertia?a.setTrace(t.invInertia):a.identity(),e.invInertia?r.setTrace(e.invInertia):r.identity(),o+=a.vmult(n).dot(n),o+=r.vmult(i).dot(i)};var Y=new t.Vec3;t.RotationalEquation.prototype.computeGWlambda=function(){var t=this.bi,e=this.bj,i=0;return t.wlambda&&(i+=t.wlambda.dot(this.njxni)),e.wlambda&&(i+=e.wlambda.dot(this.nixnj)),i},t.RotationalEquation.prototype.addToWlambda=function(t){var e=this.bi,i=this.bj,n=this.nixnj;if(this.njxni,e.invMass,i.invMass,e.wlambda){var o=this.invIi;e.wlambda.vsub(o.vmult(n).mult(t),e.wlambda)}if(i.wlambda){var o=this.invIj;i.wlambda.vadd(o.vmult(n).mult(t),i.wlambda)}},t.Constraint=function(t,e){this.equations=[],this.bodyA=t,this.bodyB=e},t.Constraint.prototype.update=function(){throw Error("method update() not implmemented in this Constraint subclass!")},t.DistanceConstraint=function(e,i,n,o){t.Constraint.call(this,e,i),o===void 0&&(o=1e6);var a=this.equations=[new t.ContactEquation(e,i)],r=a[0];r.minForce=-o,r.maxForce=o,this.update=function(){i.position.vsub(e.position,r.ni),r.ni.normalize(),r.ni.mult(.5*n,r.ri),r.ni.mult(.5*-n,r.rj)}},t.DistanceConstraint.prototype=new t.Constraint,t.RotationalMotorEquation=function(e,i,n){n=n||1e6,t.Equation.call(this,e,i,-n,n),this.axisA=new t.Vec3,this.axisB=new t.Vec3,this.invIi=new t.Mat3,this.invIj=new t.Mat3,this.targetVelocity=0},t.RotationalMotorEquation.prototype=new t.Equation,t.RotationalMotorEquation.prototype.constructor=t.RotationalMotorEquation,t.RotationalMotorEquation.prototype.computeB=function(e){var i=this.a,n=this.b,o=this.bi,a=this.bj,r=this.axisA,s=this.axisB;o.velocity;var h=o.angularVelocity?o.angularVelocity:new t.Vec3;o.force,o.tau?o.tau:new t.Vec3,a.velocity;var c=a.angularVelocity?a.angularVelocity:new t.Vec3;a.force,a.tau?a.tau:new t.Vec3,o.invMass,a.invMass;var l=this.invIi,u=this.invIj;o.invInertia?l.setTrace(o.invInertia):l.identity(),a.invInertia?u.setTrace(a.invInertia):u.identity();var p=0,v=r.dot(h)+s.dot(c)+this.targetVelocity,d=0,y=-p*i-v*n-e*d;return y},t.RotationalMotorEquation.prototype.computeC=function(){var t=this.bi,e=this.bj,i=this.axisA,n=this.axisB;t.invMass,e.invMass;var o=this.eps,a=this.invIi,r=this.invIj;return t.invInertia?a.setTrace(t.invInertia):a.identity(),e.invInertia?r.setTrace(e.invInertia):r.identity(),o+=a.vmult(i).dot(n),o+=r.vmult(n).dot(n)};var Y=new t.Vec3;t.RotationalMotorEquation.prototype.computeGWlambda=function(){var t=this.bi,e=this.bj,i=this.axisA,n=this.axisB,o=0;return t.wlambda&&(o+=t.wlambda.dot(i)),e.wlambda&&(o+=e.wlambda.dot(n)),o},t.RotationalMotorEquation.prototype.addToWlambda=function(t){var e=this.bi,i=this.bj,n=this.axisA,o=this.axisB;if(e.invMass,i.invMass,e.wlambda){var a=this.invIi;e.wlambda.vsub(a.vmult(n).mult(t),e.wlambda)}if(i.wlambda){var a=this.invIj;i.wlambda.vadd(a.vmult(o).mult(t),i.wlambda)}},t.HingeConstraint=function(e,i,n,o,a,r,s){t.Constraint.call(this,e,o),s=s||1e6;var h=this,c=this.equations=[new t.RotationalEquation(e,o),new t.RotationalEquation(e,o),new t.ContactEquation(e,o),new t.ContactEquation(e,o),new t.ContactEquation(e,o)];this.getRotationalEquation1=function(){return c[0]},this.getRotationalEquation2=function(){return c[1]},this.getPointToPointEquation1=function(){return c[2]},this.getPointToPointEquation2=function(){return c[3]},this.getPointToPointEquation3=function(){return c[4]};var l,u=this.getRotationalEquation1(),p=this.getRotationalEquation2(),v=this.getPointToPointEquation1(),d=this.getPointToPointEquation2(),y=this.getPointToPointEquation3();d.minForce=y.minForce=v.minForce=-s,d.maxForce=y.maxForce=v.maxForce=s;var f=i.unit(),m=a.unit(),w=n.cross(f),b=n.cross(w),x=r.cross(m);w.normalize(),x.normalize();var g=!1;this.motorTargetVelocity=0,this.motorMinForce=-s,this.motorMaxForce=s,this.enableMotor=function(){g||(l=new t.RotationalMotorEquation(e,o,s),c.push(l),g=!0)},this.disableMotor=function(){g&&(g=!1,l=null,c.pop())},this.update=function(){v.ni.set(1,0,0),d.ni.set(0,1,0),y.ni.set(0,0,1),e.quaternion.vmult(i,v.ri),o.quaternion.vmult(a,v.rj),v.ri.copy(d.ri),v.rj.copy(d.rj),v.ri.copy(y.ri),v.rj.copy(y.rj),e.quaternion.vmult(w,u.ni),o.quaternion.vmult(r,u.nj),e.quaternion.vmult(b,p.ni),o.quaternion.vmult(r,p.nj),g&&(e.quaternion.vmult(n,l.axisA),o.quaternion.vmult(r,l.axisB),l.targetVelocity=h.motorTargetVelocity,l.maxForce=h.motorMaxForce,l.minForce=h.motorMinForce)}},t.HingeConstraint.prototype=new t.Constraint,t.PointToPointConstraint=function(e,i,n,o,a){t.Constraint.call(this,e,n);var r=this.equations=[new t.ContactEquation(e,n),new t.ContactEquation(e,n),new t.ContactEquation(e,n)],s=r[0],h=r[1],c=r[2];h.minForce=c.minForce=s.minForce=-a,h.maxForce=c.maxForce=s.maxForce=a,this.update=function(){n.position.vsub(e.position,s.ni),s.ni.normalize(),e.quaternion.vmult(i,s.ri),n.quaternion.vmult(o,s.rj),s.ni.tangents(h.ni,c.ni),s.ri.copy(h.ri),s.rj.copy(h.rj),s.ri.copy(c.ri),s.rj.copy(c.rj)}},t.PointToPointConstraint.prototype=new t.Constraint,"undefined"!=typeof module?module.exports=t:this.CANNON=t}).apply(this);